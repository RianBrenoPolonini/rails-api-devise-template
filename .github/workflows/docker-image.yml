name: Docker Image CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file app.Dockerfile --tag my-image-name:$(date +%s)

    - name: Build db
      run: docker-compose run --rm app rails db:setup

    - name: Start server
      run: docker-compose up -d

    - name: Start lint
      run: docker-compose exec app bundle exec rubocop --parallel
      run: docker-compose exec app bundle exec bundle-audit --update
      run: docker-compose bundle exec brakeman -q -w2
      run: docker-compose bundle exec rspec